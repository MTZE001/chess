<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<title>Chess Tutor ‚Äî Play</title>
<style>
:root{--muted:#9fbfd8;--accent:#19b5ff;}
body{
  margin:0;
  min-height:100vh;
  font-family:Inter, Arial;
  background: linear-gradient(180deg,#041028,#071017);
  color:#e6f3ff;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:16px;
  padding:22px;
}
.topbar{
  width:100%;
  max-width:980px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.card{
  background:rgba(11,18,32,0.9);
  padding:10px 14px;
  border-radius:10px;
  border: 3px solid rgba(255,255,255,0.02);
}
button{
  padding:8px 12px;
  border-radius:8px;
  border:none;
  cursor:pointer;
}
#boardWrap{
  display:flex;
  gap:14px;
  align-items:flex-start;
  max-width:980px;
  width:100%;
}
#board{
  display:grid;
  grid-template-columns:repeat(8,64px);
  grid-template-rows:repeat(8,64px);
  border-radius:10px;
  overflow:hidden;
  box-shadow:inset 0 0 0  3px rgba(255,255,255,0.02);
}
.tile{
  position: relative;
  width:64px;
  height:64px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:30px;
  user-select:none;
  border:1px solid transparent;
  box-sizing:border-box;
  cursor:pointer;
  background-clip: padding-box;
}
.pieceIcon{
  position: relative;
  z-index: 1;
  font-size:60px;
  user-select:none;
}
.tile.cyan::after{
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  pointer-events: none;
  box-sizing: border-box;
  border: 4px solid cyan;
  border-radius: 0;
  z-index: 3;
}
.tile.cyan::before{
  content:'';
  position:absolute;
  inset: -6px;
  pointer-events:none;
  box-shadow: 0 0 10px 4px rgba(25,181,255,0.12);
  z-index:2;
}
.hud{
  display:flex;
  flex-direction:column;
  gap:10px;
  min-width:220px;
}
.stat{
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04));
  padding:10px;
  border-radius:8px;
}
.toast{
  position:fixed; left:50%; transform:translateX(-50%); bottom:40px;
  background:rgba(10,20,30,0.95); padding:10px 14px; border-radius:8px; color:#e6f3ff; box-shadow:0 6px 18px rgba(0,0,0,0.6);
}
</style>
</head>
<body>
<div class="topbar" style="max-width:980px;width:100%">
  <div class="card"><strong>Chess Tutor ‚Äî ‡πÑ‡∏•‡πà‡∏à‡∏±‡∏ö‡∏´‡∏°‡∏≤‡∏Å‡∏î‡∏≥</strong>
    <div style="margin-top:6px;font-size:13px;color:#9fbfd8;">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ‡∏Å‡∏¥‡∏ô‡∏´‡∏°‡∏≤‡∏Å‡∏î‡∏≥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚Üí ‡πÄ‡∏Å‡∏°‡∏à‡∏∞‡∏™‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ä‡∏ô‡∏∞</div>
  </div>
  <div style="display:flex;gap:8px;">
    <button onclick="location.href='select.html'">üîÅ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏Å</button>
    <button onclick="location.href='settings.html'">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
    <button onclick="resetGame()" style="background:linear-gradient(90deg,#ff9a19,#ffd86b);">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏Å‡∏°</button>
    <button onclick="clearStats()" style="background:linear-gradient(90deg,#ff6b6b,#ff9a9e);">‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</button>
  </div>
</div>

<div id="boardWrap" style="max-width:980px;width:100%">
  <div id="board" class="card"></div>
  <div class="hud">
    <div class="stat"><strong>‡∏´‡∏°‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:</strong> <span id="myType"></span></div>
    <div class="stat"><strong>‡∏´‡∏°‡∏≤‡∏Å‡∏î‡∏≥‡πÄ‡∏´‡∏•‡∏∑‡∏≠:</strong> <span id="enemiesLeft">0</span></div>
    <div class="stat"><strong>‡∏ä‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</strong> <span id="winsCount">0</span></div>
    <div class="stat"><strong>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏î‡πà‡∏≤‡∏ô (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ):</strong> <span id="avgTime">0</span></div>
    <div class="stat"><strong>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</strong><div style="color:#9fbfd8;font-size:13px;">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ï‡∏±‡∏ß‡∏´‡∏°‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Üí ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ï‡πå‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏ô‡πÑ‡∏î‡πâ (‡∏Ç‡∏≠‡∏ö‡∏ü‡πâ‡∏≤) ‚Üí ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏¥‡∏ô</div></div>
  </div>
</div>

<script>
const icons = { king:"‚ôö", queen:"‚ôõ", rook:"‚ôú", bishop:"‚ôù", knight:"‚ôû", pawn:"‚ôü" };
let myType = localStorage.getItem('selectedPiece') || 'knight';
if(myType==='pawn'){ myType='knight'; localStorage.setItem('selectedPiece',myType);}
document.getElementById('myType').textContent=myType.toUpperCase();

let lightColor=localStorage.getItem('boardLight')||'#f0f0f0';
let darkColor=localStorage.getItem('boardDark')||'#4a4a4a';
let defaultBorder=localStorage.getItem('boardBorder')||'transparent';

let pieces=[];
let selectedIndex=null;
const boardEl=document.getElementById('board');
const enemiesLeftEl=document.getElementById('enemiesLeft');
const winsCountEl = document.getElementById('winsCount');
const avgTimeEl = document.getElementById('avgTime');

// --- Stats ---
const WINS_KEY = 'chessTutor_wins_v1';
const AVG_TIME_KEY = 'chessTutor_avgTime_v1';
let wins = parseInt(localStorage.getItem(WINS_KEY)) || 0;
let avgTime = parseFloat(localStorage.getItem(AVG_TIME_KEY)) || 0;
let startTime = 0;

function saveStats(){
  localStorage.setItem(WINS_KEY, String(wins));
  localStorage.setItem(AVG_TIME_KEY, String(avgTime));
}
function clearStats(){ wins=0; avgTime=0; saveStats(); updateHUD(); showToast('‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); }

function tileIndex(x,y){ return pieces.findIndex(p=>p.x===x && p.y===y); }
function pathClear(p,tx,ty){ 
  const dx=tx-p.x,dy=ty-p.y;
  const sx=Math.sign(dx),sy=Math.sign(dy);
  let cx=p.x+sx,cy=p.y+sy;
  while(cx!==tx||cy!==ty){
    if(tileIndex(cx,cy)!==-1)return false;
    cx+=sx;cy+=sy;
  }
  return true;
}
function validMove(p,x,y){
  if(x<0||x>7||y<0||y>7) return false;
  if(p.x===x&&p.y===y) return false;
  const dx=x-p.x, dy=y-p.y;
  switch(p.type){
    case 'king': return Math.max(Math.abs(dx),Math.abs(dy))===1;
    case 'queen': return (dx===0||dy===0||Math.abs(dx)===Math.abs(dy)) && pathClear(p,x,y);
    case 'rook': return (dx===0||dy===0)&&pathClear(p,x,y);
    case 'bishop': return Math.abs(dx)===Math.abs(dy)&&((p.x+p.y)%2===((x+y)%2))&&pathClear(p,x,y);
    case 'knight': return (Math.abs(dx)===2&&Math.abs(dy)===1)||(Math.abs(dx)===1&&Math.abs(dy)===2);
    case 'pawn': return dx===0&&dy===-1;
    default: return false;
  }
}
function spawnEnemies(){
  const count=4+Math.floor(Math.random()*5);
  const possible=['pawn','rook','bishop','knight','queen'];
  const player=pieces.find(p=>p.owner==='player');
  const parity=(player.x+player.y)%2;
  let placed=0, attempts=0;
  while(placed<count && attempts<600){
    attempts++;
    let x=Math.floor(Math.random()*8),y=Math.floor(Math.random()*8);
    if(pieces.some(p=>p.x===x&&p.y===y)) continue;
    let t=possible[Math.floor(Math.random()*possible.length)];
    if(t==='bishop'&&((x+y)%2)!==parity){
      for(let r=0;r<50;r++){
        const nx=Math.floor(Math.random()*8),ny=Math.floor(Math.random()*8);
        if(pieces.some(p=>p.x===nx&&p.y===ny)) continue;
        if((nx+ny)%2===parity){x=nx;y=ny; break;}
      }
    }
    pieces.push({x,y,type:t,owner:'enemy'}); placed++;
  }
}

function initGame(){
  pieces=[{x:4,y:4,type:myType,owner:'player'}];
  spawnEnemies();
  selectedIndex=null;
  startTime = Date.now();
  draw(); updateHUD();
}

function draw(){
  boardEl.innerHTML='';
  for(let y=0;y<8;y++){
    for(let x=0;x<8;x++){
      const t=document.createElement('div'); t.className='tile';
      t.dataset.x=x; t.dataset.y=y;
      t.style.background=((x+y)%2===0)?lightColor:darkColor;
      t.style.borderColor=defaultBorder;
      const idx=tileIndex(x,y);
      if(idx!==-1){
        const p=pieces[idx];
        const span=document.createElement('div');
        span.className='pieceIcon';
        span.textContent=icons[p.type];
        span.style.color=p.owner==='enemy'?'#0a0a0a':'#fff';
        t.appendChild(span);
      }
      t.addEventListener('click',()=>onTileClick(x,y));
      boardEl.appendChild(t);
    }
  }
  showHighlights();
}

let highlighted=[];
function showHighlights(){
  highlighted.forEach(t=>t.classList.remove('cyan')); highlighted=[];
  if(selectedIndex===null) return;
  const p=pieces[selectedIndex];
  boardEl.querySelectorAll('.tile').forEach(t=>{
    const x=+t.dataset.x,y=+t.dataset.y;
    if(validMove(p,x,y)) {t.classList.add('cyan'); highlighted.push(t);}
  });
}

function onTileClick(x,y){
  const idx=tileIndex(x,y);
  if(idx!==-1 && pieces[idx].owner==='player'){
    if(selectedIndex===idx){selectedIndex=null; showHighlights(); return;}
    selectedIndex=idx; showHighlights(); return;
  }
  if(selectedIndex!==null){
    const p=pieces[selectedIndex];
    if(validMove(p,x,y)){
      if(idx!==-1 && pieces[idx].owner==='enemy') pieces.splice(idx,1);
      p.x=x; p.y=y; selectedIndex=null; draw(); updateHUD(); checkWin();
    }
  }
}

function updateHUD(){
  enemiesLeftEl.textContent=pieces.filter(p=>p.owner==='enemy').length;
  winsCountEl.textContent = wins;
  avgTimeEl.textContent = avgTime.toFixed(1);
}

function checkWin(){
  if(pieces.filter(p=>p.owner==='enemy').length===0){
    let elapsed = (Date.now() - startTime)/1000;
    avgTime = wins === 0 ? elapsed : (avgTime * wins + elapsed) / (wins + 1);
    wins++;
    saveStats();
    updateHUD();
    showToast(`‡∏ä‡∏ô‡∏∞! ‡πÄ‡∏ß‡∏•‡∏≤: ${elapsed.toFixed(1)}s | ‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: ${avgTime.toFixed(1)}s`);
    setTimeout(()=>{initGame();},300);
  }
}

function resetGame(){ initGame(); }
function showToast(text,ms=1600){
  const d=document.createElement('div'); d.className='toast'; d.textContent=text; document.body.appendChild(d);
  setTimeout(()=>{ d.style.transition='opacity 300ms'; d.style.opacity='0'; setTimeout(()=>d.remove(),300); },ms);
}

initGame();
</script>
</body>
</html>
